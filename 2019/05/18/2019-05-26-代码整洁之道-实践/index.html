<!DOCTYPE html>
<html lang="en">
  <head><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="代码整洁之道-实践"/><meta name="keywords" content="技术 Java Rust" /><link rel="alternate" href="/atom.xml" title="Ubik's blog"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=" />
<link rel="canonical" href="http://yoursite.com/2019/05/18/2019-05-26-代码整洁之道-实践/"/>

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" /><script type="text/x-mathjax-config">
    MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
  </script>
  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<link rel="stylesheet" type="text/css" href="/css/style.css?v=" />

<script id="baidu_analytics">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?7f52ad98103933a0875502b3b2a71682";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script><script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":"","latex":true};
</script>

    <title>代码整洁之道-实践 - Ubik's blog</title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Ubik's blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">Home
          </li>
      </a><a href="/archives/">
        <li class="mobile-menu-item">Archives
          </li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags
          </li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Ubik's blog</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            Home
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            Archives
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/tags/">
            Tags
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/about/">
            About
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><article class="post">
    <header class="post-header">
      <h1 class="post-title">代码整洁之道-实践
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-05-18
        </span></div>
    </header>

    <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#摘要"><span class="toc-text">摘要</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#系统使用样例"><span class="toc-text">系统使用样例</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Clean-Code"><span class="toc-text">Clean Code</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ArgumentMarshaler-接口"><span class="toc-text">ArgumentMarshaler 接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ArgsException"><span class="toc-text">ArgsException</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#脏代码"><span class="toc-text">脏代码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#如何破坏"><span class="toc-text">如何破坏</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#如何改进"><span class="toc-text">如何改进</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考资料"><span class="toc-text">参考资料</span></a></li></ol>
    </div>
  </div><div class="post-content"><p><img src="/img/code-clean-practice.jpg" alt="插图"></p>
<h1 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h1><p> 通过阅读一个 Args 程序，了解整洁代码应该是什么样的（极好的可读性），然后通过与重构之前的肮脏代码对比，了解要改进的地方。最后通过作者的先复杂化导致出现代码变脏，随后建立规程优化代码的历程，了解代码整洁的最佳实践。</p>
<h1 id="系统使用样例"><a href="#系统使用样例" class="headerlink" title="系统使用样例"></a>系统使用样例</h1><p> 帮助你理解 Args 程序的功能：通过 Args()构造参数创建实体，解析之后可以使用Get* 用参数名称获取参数值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Args arg = <span class="keyword">new</span> Args(<span class="string">"l,p#,d*"</span>, args);</span><br><span class="line">        <span class="keyword">boolean</span> logging = arg.getBoolean(<span class="string">'l'</span>);</span><br><span class="line">        <span class="keyword">int</span> port = arg.getInt(<span class="string">'p'</span>);</span><br><span class="line">        String directory = arg.getString(<span class="string">'d'</span>);</span><br><span class="line">        executeApplication(logging, port, directory);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</span><br><span class="line">        System.out.printf(<span class="string">"Argument error: %s\n"</span>, e.errorMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Clean-Code"><a href="#Clean-Code" class="headerlink" title="Clean Code"></a>Clean Code</h1><p>上边是一个命令行参数解析程序，我们用这个例子来演示逐步改进，它非常易于使用，只用简单地用输入参数和格式化字符串构造Args类，再向Args对象查询参数值即可。下边是其最终实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.objectmentor.utilities.args.ArgsException.ErrorCode.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Args</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;Character, ArgumentMarshaler&gt; marshalers;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;Character&gt; argsFound;</span><br><span class="line">    <span class="keyword">private</span> ListIterator&lt;String&gt; currentArgument;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Args</span><span class="params">(String schema, String[] args)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</span><br><span class="line">        marshalers = <span class="keyword">new</span> HashMap&lt;Character, ArgumentMarshaler&gt;();</span><br><span class="line">        argsFound = <span class="keyword">new</span> HashSet&lt;Character&gt;();</span><br><span class="line"></span><br><span class="line">        parseSchema(schema);</span><br><span class="line">        parseArgumentStrings(Arrays.asList(args));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSchema</span><span class="params">(String schema)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (String element : schema.split(<span class="string">","</span>))</span><br><span class="line">            <span class="keyword">if</span> (element.length() &gt; <span class="number">0</span>)</span><br><span class="line">                parseSchemaElement(element.trim());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSchemaElement</span><span class="params">(String element)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</span><br><span class="line">        <span class="keyword">char</span> elementId = element.charAt(<span class="number">0</span>);</span><br><span class="line">        String elementTail = element.substring(<span class="number">1</span>);</span><br><span class="line">        validateSchemaElementId(elementId);</span><br><span class="line">        <span class="keyword">if</span> (elementTail.length() == <span class="number">0</span>)</span><br><span class="line">            marshalers.put(elementId, <span class="keyword">new</span> BooleanArgumentMarshaler());</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (elementTail.equals(<span class="string">"*"</span>))</span><br><span class="line">            marshalers.put(elementId, <span class="keyword">new</span> StringArgumentMarshaler());</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (elementTail.equals(<span class="string">"#"</span>))</span><br><span class="line">            marshalers.put(elementId, <span class="keyword">new</span> IntegerArgumentMarshaler());</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (elementTail.equals(<span class="string">"##"</span>))</span><br><span class="line">            marshalers.put(elementId, <span class="keyword">new</span> DoubleArgumentMarshaler());</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (elementTail.equals(<span class="string">"[*]"</span>))</span><br><span class="line">            marshalers.put(elementId, <span class="keyword">new</span> StringArrayArgumentMarshaler());</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException(INVALID_ARGUMENT_FORMAT, elementId, elementTail);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">validateSchemaElementId</span><span class="params">(<span class="keyword">char</span> elementId)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!Character.isLetter(elementId))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException(INVALID_ARGUMENT_NAME, elementId, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseArgumentStrings</span><span class="params">(List&lt;String&gt; argsList)</span> <span class="keyword">throws</span> ArgsException</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (currentArgument = argsList.listIterator(); currentArgument.hasNext();)</span><br><span class="line">        &#123;</span><br><span class="line">            String argString = currentArgument.next();</span><br><span class="line">            <span class="keyword">if</span> (argString.startsWith(<span class="string">"-"</span>)) &#123;</span><br><span class="line">                parseArgumentCharacters(argString.substring(<span class="number">1</span>));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                currentArgument.previous();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseArgumentCharacters</span><span class="params">(String argChars)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; argChars.length(); i++)</span><br><span class="line">            parseArgumentCharacter(argChars.charAt(i));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseArgumentCharacter</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</span><br><span class="line">        ArgumentMarshaler m = marshalers.get(argChar);</span><br><span class="line">        <span class="keyword">if</span> (m == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException(UNEXPECTED_ARGUMENT, argChar, <span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            argsFound.add(argChar);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                m.set(currentArgument);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</span><br><span class="line">                e.setErrorArgumentId(argChar);</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">has</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> argsFound.contains(arg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">nextArgument</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> currentArgument.nextIndex();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getBoolean</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BooleanArgumentMarshaler.getValue(marshalers.get(arg));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getString</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> StringArgumentMarshaler.getValue(marshalers.get(arg));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getInt</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> IntegerArgumentMarshaler.getValue(marshalers.get(arg));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getDouble</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> DoubleArgumentMarshaler.getValue(marshalers.get(arg));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String[] getStringArray(<span class="keyword">char</span> arg) &#123;</span><br><span class="line">        <span class="keyword">return</span> StringArrayArgumentMarshaler.getValue(marshalers.get(arg));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ArgumentMarshaler-接口"><a href="#ArgumentMarshaler-接口" class="headerlink" title="ArgumentMarshaler 接口"></a>ArgumentMarshaler 接口</h2><p>很明显 ArgumentMarshaler 接口在 Map 中充当 Value，他的接口实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">set</span><span class="params">(Iterator&lt;String&gt; currentArgument)</span> <span class="keyword">throws</span> ArgsException</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//BooleanArgumentMarshaler.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BooleanArgumentMarshaler</span> <span class="keyword">implements</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> booleanValue = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Iterator&lt;String&gt; currentArgument)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</span><br><span class="line">        booleanValue = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">getValue</span><span class="params">(ArgumentMarshaler am)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (am != <span class="keyword">null</span> &amp;&amp; am <span class="keyword">instanceof</span> BooleanArgumentMarshaler)</span><br><span class="line">            <span class="keyword">return</span> ((BooleanArgumentMarshaler) am).booleanValue;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//StringArgumentMarshaler.java</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.objectmentor.utilities.args.ArgsException.ErrorCode.*;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringArgumentMarshaler</span> <span class="keyword">implements</span> <span class="title">ArgumentMarshaler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String stringValue = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Iterator&lt;String&gt; currentArgument)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stringValue = currentArgument.next();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchElementException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException(MISSING_STRING);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getValue</span><span class="params">(ArgumentMarshaler am)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (am != <span class="keyword">null</span> &amp;&amp; am <span class="keyword">instanceof</span> StringArgumentMarshaler)</span><br><span class="line">            <span class="keyword">return</span> ((StringArgumentMarshaler) am).stringValue;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ArgsException"><a href="#ArgsException" class="headerlink" title="ArgsException"></a>ArgsException</h2><p>除此之外，还有ArgsException的定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.objectmentor.utilities.args.ArgsException.ErrorCode.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArgsException</span> <span class="keyword">extends</span> <span class="title">Exception</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">char</span> errorArgumentId = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="keyword">private</span> String errorParameter = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> ErrorCode errorCode = OK;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArgsException</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArgsException</span><span class="params">(String message)</span> </span>&#123;<span class="keyword">super</span>(message);&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArgsException</span><span class="params">(ErrorCode errorCode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.errorCode = errorCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArgsException</span><span class="params">(ErrorCode errorCode, String errorParameter)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.errorCode = errorCode;</span><br><span class="line">        <span class="keyword">this</span>.errorParameter = errorParameter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ArgsException</span><span class="params">(ErrorCode errorCode,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">char</span> errorArgumentId, String errorParameter)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.errorCode = errorCode;</span><br><span class="line">        <span class="keyword">this</span>.errorParameter = errorParameter;</span><br><span class="line">        <span class="keyword">this</span>.errorArgumentId = errorArgumentId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">char</span> <span class="title">getErrorArgumentId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> errorArgumentId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setErrorArgumentId</span><span class="params">(<span class="keyword">char</span> errorArgumentId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.errorArgumentId = errorArgumentId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getErrorParameter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> errorParameter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setErrorParameter</span><span class="params">(String errorParameter)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.errorParameter = errorParameter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ErrorCode <span class="title">getErrorCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> errorCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setErrorCode</span><span class="params">(ErrorCode errorCode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.errorCode = errorCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">errorMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (errorCode) &#123;</span><br><span class="line">            <span class="keyword">case</span> OK:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"TILT: Should not get here."</span>;</span><br><span class="line">            <span class="keyword">case</span> UNEXPECTED_ARGUMENT:</span><br><span class="line">                <span class="keyword">return</span> String.format(<span class="string">"Argument -%c unexpected."</span>, errorArgumentId);</span><br><span class="line">            <span class="keyword">case</span> MISSING_STRING:</span><br><span class="line">                <span class="keyword">return</span> String.format(<span class="string">"Could not find string parameter for -%c."</span>,</span><br><span class="line">                                errorArgumentId);</span><br><span class="line">            <span class="keyword">case</span> INVALID_INTEGER:</span><br><span class="line">                <span class="keyword">return</span> String.format(<span class="string">"Argument -%c expects an integer but was '%s'."</span>,</span><br><span class="line">                                errorArgumentId, errorParameter);</span><br><span class="line">            <span class="keyword">case</span> MISSING_INTEGER:</span><br><span class="line">                <span class="keyword">return</span> String.format(<span class="string">"Could not find integer parameter for -%c."</span>,</span><br><span class="line">                                errorArgumentId);</span><br><span class="line">            <span class="keyword">case</span> INVALID_DOUBLE:</span><br><span class="line">                <span class="keyword">return</span> String.format(<span class="string">"Argument -%c expects a double but was '%s'."</span>,</span><br><span class="line">                                errorArgumentId, errorParameter);</span><br><span class="line">            <span class="keyword">case</span> MISSING_DOUBLE:</span><br><span class="line">                <span class="keyword">return</span> String.format(<span class="string">"Could not find double parameter for -%c."</span>,</span><br><span class="line">                                errorArgumentId);</span><br><span class="line">            <span class="keyword">case</span> INVALID_ARGUMENT_NAME:</span><br><span class="line">                <span class="keyword">return</span> String.format(<span class="string">"'%c' is not a valid argument name."</span>,</span><br><span class="line">                                errorArgumentId);</span><br><span class="line">            <span class="keyword">case</span> INVALID_ARGUMENT_FORMAT:</span><br><span class="line">                <span class="keyword">return</span> String.format(<span class="string">"'%s' is not a valid argument format."</span>,</span><br><span class="line">                                errorParameter);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> ErrorCode &#123;</span><br><span class="line">        OK, INVALID_ARGUMENT_FORMAT, UNEXPECTED_ARGUMENT, INVALID_ARGUMENT_NAME,</span><br><span class="line">        MISSING_STRING,</span><br><span class="line">        MISSING_INTEGER, INVALID_INTEGER,</span><br><span class="line">        MISSING_DOUBLE, INVALID_DOUBLE&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="脏代码"><a href="#脏代码" class="headerlink" title="脏代码"></a>脏代码</h1><p>可以看出，代码足够整洁————你可以从第一行看到最后一行，在没有注释的情况下基本理解其含义。但在一开始，代码很肮脏，如下所示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.text.ParseException;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Args</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String schema;</span><br><span class="line">    <span class="keyword">private</span> String[] args;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> valid = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;Character&gt; unexpectedArguments = <span class="keyword">new</span> TreeSet&lt;Character&gt;();</span><br><span class="line">    <span class="keyword">private</span> Map&lt;Character, Boolean&gt; booleanArgs =</span><br><span class="line">    <span class="keyword">new</span> HashMap&lt;Character, Boolean&gt;();</span><br><span class="line">    <span class="keyword">private</span> Map&lt;Character, String&gt; stringArgs = <span class="keyword">new</span> HashMap&lt;Character, String&gt;();</span><br><span class="line">    <span class="keyword">private</span> Map&lt;Character, Integer&gt; intArgs = <span class="keyword">new</span> HashMap&lt;Character, Integer&gt;();</span><br><span class="line">    <span class="keyword">private</span> Set&lt;Character&gt; argsFound = <span class="keyword">new</span> HashSet&lt;Character&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> currentArgument;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">char</span> errorArgumentId = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="keyword">private</span> String errorParameter = <span class="string">"TILT"</span>;</span><br><span class="line">    <span class="keyword">private</span> ErrorCode errorCode = ErrorCode.OK;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">enum</span> ErrorCode &#123;</span><br><span class="line">        OK, MISSING_STRING, MISSING_INTEGER, INVALID_INTEGER, UNEXPECTED_ARGUMENT&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Args</span><span class="params">(String schema, String[] args)</span> <span class="keyword">throws</span> ParseException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.schema = schema;</span><br><span class="line">        <span class="keyword">this</span>.args = args;</span><br><span class="line">        valid = parse();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parse</span><span class="params">()</span> <span class="keyword">throws</span> ParseException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (schema.length() == <span class="number">0</span> &amp;&amp; args.length == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        parseSchema();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            parseArguments();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ArgsException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> valid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseSchema</span><span class="params">()</span> <span class="keyword">throws</span> ParseException </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (String element : schema.split(<span class="string">","</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (element.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                String trimmedElement = element.trim();</span><br><span class="line">                parseSchemaElement(trimmedElement);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseSchemaElement</span><span class="params">(String element)</span> <span class="keyword">throws</span> ParseException </span>&#123;</span><br><span class="line">        <span class="keyword">char</span> elementId = element.charAt(<span class="number">0</span>);</span><br><span class="line">        String elementTail = element.substring(<span class="number">1</span>);</span><br><span class="line">        validateSchemaElementId(elementId);</span><br><span class="line">        <span class="keyword">if</span> (isBooleanSchemaElement(elementTail))</span><br><span class="line">            parseBooleanSchemaElement(elementId);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (isStringSchemaElement(elementTail))</span><br><span class="line">            parseStringSchemaElement(elementId);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (isIntegerSchemaElement(elementTail)) &#123;</span><br><span class="line">            parseIntegerSchemaElement(elementId);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ParseException(</span><br><span class="line">                    String.format(<span class="string">"Argument: %c has invalid format: %s."</span>,</span><br><span class="line">                    elementId, elementTail), <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">validateSchemaElementId</span><span class="params">(<span class="keyword">char</span> elementId)</span> <span class="keyword">throws</span> ParseException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!Character.isLetter(elementId)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ParseException(</span><br><span class="line">                    <span class="string">"Bad character:"</span> + elementId + <span class="string">"in Args format: "</span> + schema, <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseBooleanSchemaElement</span><span class="params">(<span class="keyword">char</span> elementId)</span> </span>&#123;</span><br><span class="line">        booleanArgs.put(elementId, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseIntegerSchemaElement</span><span class="params">(<span class="keyword">char</span> elementId)</span> </span>&#123;</span><br><span class="line">        intArgs.put(elementId, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseStringSchemaElement</span><span class="params">(<span class="keyword">char</span> elementId)</span> </span>&#123;</span><br><span class="line">        stringArgs.put(elementId, <span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isStringSchemaElement</span><span class="params">(String elementTail)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> elementTail.equals(<span class="string">"*"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isBooleanSchemaElement</span><span class="params">(String elementTail)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> elementTail.length() == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isIntegerSchemaElement</span><span class="params">(String elementTail)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> elementTail.equals(<span class="string">"#"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseArguments</span><span class="params">()</span> <span class="keyword">throws</span> ArgsException </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (currentArgument = <span class="number">0</span>; currentArgument &lt; args.length; currentArgument++)</span><br><span class="line">        &#123;</span><br><span class="line">            String arg = args[currentArgument];</span><br><span class="line">            parseArgument(arg);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseArgument</span><span class="params">(String arg)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (arg.startsWith(<span class="string">"-"</span>))</span><br><span class="line">            parseElements(arg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseElements</span><span class="params">(String arg)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; arg.length(); i++)</span><br><span class="line">            parseElement(arg.charAt(i));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">parseElement</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (setArgument(argChar))</span><br><span class="line">            argsFound.add(argChar);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            unexpectedArguments.add(argChar);</span><br><span class="line">        errorCode = ErrorCode.UNEXPECTED_ARGUMENT;</span><br><span class="line">        valid = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">setArgument</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isBooleanArg(argChar))</span><br><span class="line">            setBooleanArg(argChar, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (isStringArg(argChar))</span><br><span class="line">            setStringArg(argChar);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (isIntArg(argChar))</span><br><span class="line">            setIntArg(argChar);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isIntArg</span><span class="params">(<span class="keyword">char</span> argChar)</span> </span>&#123;<span class="keyword">return</span> intArgs.containsKey(argChar);&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setIntArg</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</span><br><span class="line">        currentArgument++;</span><br><span class="line">        String parameter = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            parameter = args[currentArgument];</span><br><span class="line">            intArgs.put(argChar, <span class="keyword">new</span> Integer(parameter));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException e) &#123;</span><br><span class="line">            valid = <span class="keyword">false</span>;</span><br><span class="line">            errorArgumentId = argChar;</span><br><span class="line">            errorCode = ErrorCode.MISSING_INTEGER;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">            valid = <span class="keyword">false</span>;</span><br><span class="line">            errorArgumentId = argChar;</span><br><span class="line">            errorParameter = parameter;</span><br><span class="line">            errorCode = ErrorCode.INVALID_INTEGER;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setStringArg</span><span class="params">(<span class="keyword">char</span> argChar)</span> <span class="keyword">throws</span> ArgsException </span>&#123;</span><br><span class="line">        currentArgument++;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stringArgs.put(argChar, args[currentArgument]);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ArrayIndexOutOfBoundsException e) &#123;</span><br><span class="line">            valid = <span class="keyword">false</span>;</span><br><span class="line">            errorArgumentId = argChar;</span><br><span class="line">            errorCode = ErrorCode.MISSING_STRING;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgsException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isStringArg</span><span class="params">(<span class="keyword">char</span> argChar)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> stringArgs.containsKey(argChar);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setBooleanArg</span><span class="params">(<span class="keyword">char</span> argChar, <span class="keyword">boolean</span> value)</span> </span>&#123;</span><br><span class="line">        booleanArgs.put(argChar, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isBooleanArg</span><span class="params">(<span class="keyword">char</span> argChar)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> booleanArgs.containsKey(argChar);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">cardinality</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> argsFound.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">usage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (schema.length() &gt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"-["</span> + schema + <span class="string">"]"</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">errorMessage</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (errorCode) &#123;</span><br><span class="line">            <span class="keyword">case</span> OK:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">"TILT: Should not get here."</span>);</span><br><span class="line">            <span class="keyword">case</span> UNEXPECTED_ARGUMENT:</span><br><span class="line">                <span class="keyword">return</span> unexpectedArgumentMessage();</span><br><span class="line">            <span class="keyword">case</span> MISSING_STRING:</span><br><span class="line">                <span class="keyword">return</span> String.format(<span class="string">"Could not find string parameter for -%c."</span>,</span><br><span class="line">                                errorArgumentId);</span><br><span class="line">            <span class="keyword">case</span> INVALID_INTEGER:</span><br><span class="line">                <span class="keyword">return</span> String.format(<span class="string">"Argument -%c expects an integer but was '%s'."</span>,</span><br><span class="line">                                errorArgumentId, errorParameter);</span><br><span class="line">            <span class="keyword">case</span> MISSING_INTEGER:</span><br><span class="line">                <span class="keyword">return</span> String.format(<span class="string">"Could not find integer parameter for -%c."</span>,</span><br><span class="line">                                errorArgumentId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">unexpectedArgumentMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        StringBuffer message = <span class="keyword">new</span> StringBuffer(<span class="string">"Argument(s) -"</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">char</span> c : unexpectedArguments) &#123;</span><br><span class="line">            message.append(c);</span><br><span class="line">        &#125;</span><br><span class="line">        message.append(<span class="string">" unexpected."</span>);</span><br><span class="line">        <span class="keyword">return</span> message.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">falseIfNull</span><span class="params">(Boolean b)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> b != <span class="keyword">null</span> &amp;&amp; b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">zeroIfNull</span><span class="params">(Integer i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> i == <span class="keyword">null</span> ? <span class="number">0</span> : i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">blankIfNull</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> s == <span class="keyword">null</span> ? <span class="string">""</span> : s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getString</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> blankIfNull(stringArgs.get(arg));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getInt</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> zeroIfNull(intArgs.get(arg));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getBoolean</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> falseIfNull(booleanArgs.get(arg));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">has</span><span class="params">(<span class="keyword">char</span> arg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> argsFound.contains(arg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isValid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> valid;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ArgsException</span> <span class="keyword">extends</span> <span class="title">Exception</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 显然，这段代码需要打磨————TILT之类名称奇怪的字符串、HashSet 和 TreeSets，还有奇怪的 try-catch-finally 块。产生这些东西的原因是作者在一开始的只支持 Boolean 类型的代码上强行添加了 String 和 Integer 类。</p>
<h1 id="如何破坏"><a href="#如何破坏" class="headerlink" title="如何破坏"></a>如何破坏</h1><p> 通过对比作者的意图、初始目标和最后一段代码，也就是烂的实现，我们可以发现，毁坏程序最好的方法就是<strong>以改动之名大动其结构，有些程序甚至永远不能从这种所谓“改 进”中恢复过来。</strong></p>
<h1 id="如何改进"><a href="#如何改进" class="headerlink" title="如何改进"></a>如何改进</h1><p> 作者改进烂代码的方法是 TDD，这样来保证系统始终能够运行，不会作出破坏系统的修改，每次修改都保证系统像之前一样工作。</p>
<p> 具体来说，<strong>用JUnit管理单元测试、用 Fitnesse 完成验收测试</strong>，以 wiki 形式写程。从而，随时能够运行这些测试就说名系统以我们期望的方式工作。</p>
<p> 个人在改进、重构代码时，也可以采用类似的方法。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li>《代码整洁之道》 作者：[美] Robert C·Martin 译者: 韩磊 </li>
</ul>

      </div>
      <div class="post-copyright">
    <p class="copyright-item">
      <span>Author: </span>
      <a href="http://yoursite.com">Adam Ubik</a>
    </p>
    <p class="copyright-item">
      <span>License: </span><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>
      <footer class="post-footer">
        <div class="post-tags">
            <a href="/tags/Summary/">Summary</a>
            <a href="/tags/Clean-Code/">Clean Code</a>
            <a href="/tags/%E5%AE%9E%E8%B7%B5/">实践</a>
            </div>
        
        <nav class="post-nav"><a class="prev" href="/2019/05/29/2019-05-23-JDK%E5%AE%9E%E7%8E%B0%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84RPC%E6%A1%86%E6%9E%B6/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">Java 实现最简单的RPC框架</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    <a class="next" href="/2019/05/18/2019-07-22-Netty%E7%9A%84%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E6%A3%80%E6%B5%8B/">
        <span class="next-text nav-default">Netty 的内存泄漏检测</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></footer>
    </article></div><div class="comments" id="comments"></div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:Dingbiao1998@icloud.com" target="_blank" rel="noopener" class="iconfont icon-email" title="email"></a>
        <a href="https://github.com/Ubique0305" target="_blank" rel="noopener" class="iconfont icon-github" title="github"></a>
        <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><div class="copyright">
  <span class="copyright-year">&copy;2018 - 2019<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Adam Ubik</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v="></script>
<script src="/node_modules/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"node_modules/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/node_modules/assets/wanko.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body>
</html>
